#import "../template.typ": *
#pagebreak()
= ç¡¬ä»¶è§†è§’çš„æ“ä½œç³»ç»Ÿ

== å›é¡¾ï¼šè®¡ç®—æœºç¡¬ä»¶

=== è®¡ç®—æœºç¡¬ä»¶ = æ•°å­—ç”µè·¯

æ•°å­—ç”µè·¯æ¨¡æ‹Ÿå™¨ (Logisim)

- åŸºæœ¬æ„ä»¶ï¼šwire, reg, NAND
- æ¯ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ
- å…ˆè®¡ç®— wire çš„å€¼
- åœ¨å‘¨æœŸç»“æŸæ—¶æŠŠå€¼é”å­˜è‡³ reg

"æ¨¡æ‹Ÿ" çš„æ„ä¹‰

- ç¨‹åºæ˜¯ "ä¸¥æ ¼çš„æ•°å­¦å¯¹è±¡"
- å®ç°æ¨¡æ‹Ÿå™¨æ„å‘³ç€ "å®Œå…¨æŒæ¡ç³»ç»Ÿè¡Œä¸º"

=== è®¡ç®—æœºç¡¬ä»¶çš„çŠ¶æ€æœºæ¨¡å‹

ä¸ä»…æ˜¯ç¨‹åº, æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº

- çŠ¶æ€ï¼šå†…å­˜å’Œå¯„å­˜å™¨æ•°å€¼
- åˆå§‹çŠ¶æ€ï¼šæ‰‹å†Œè§„å®š (CPU Reset)
- çŠ¶æ€è¿ç§»
  - ä»»æ„é€‰æ‹©ä¸€ä¸ªå¤„ç†å™¨ cpu
  - å“åº”å¤„ç†å™¨å¤–éƒ¨ä¸­æ–­
  - ä» cpu.PC å–æŒ‡ä»¤æ‰§è¡Œ

åˆ°åº•è°å®šä¹‰äº†çŠ¶æ€æœºçš„è¡Œä¸ºï¼Ÿ æˆ‘ä»¬å¦‚ä½•æ§åˆ¶ "ä»€ä¹ˆç¨‹åºè¿è¡Œ"ï¼Ÿ ä¸ºäº†è®© "æ“ä½œç³»ç»Ÿ"
è¿™ä¸ªç¨‹åºèƒ½å¤Ÿæ­£ç¡®å¯åŠ¨, è®¡ç®—æœºç¡¬ä»¶ç³»ç»Ÿå¿…å®šå’Œç¨‹åºå‘˜ä¹‹é—´å­˜åœ¨çº¦å®šâ€”â€”é¦–å…ˆå°±æ˜¯ Reset
çš„çŠ¶æ€, ç„¶åæ˜¯ Reset ä»¥åæ‰§è¡Œçš„ç¨‹åºåº”è¯¥åšä»€ä¹ˆ.

== ç¡¬ä»¶ä¸ç¨‹åºå‘˜çš„çº¦å®š

=== Bare-metal ä¸ç¨‹åºå‘˜çš„çº¦å®š

Bare-metal ä¸å‚å•†çš„çº¦å®š

- CPU Reset åçš„çŠ¶æ€ (å¯„å­˜å™¨å€¼)
  - å‚å•†è‡ªç”±å¤„ç†è¿™ä¸ªåœ°å€ä¸Šçš„å€¼
  - Memory-mapped I/O

> reset å,cpu å°±æ˜¯æ— æƒ…çš„æ‰§è¡ŒæŒ‡ä»¤çš„æœºå™¨, ä¸»æ¿ç”Ÿäº§å‚å•†åªè¦åœ¨ reset pc
æ‰€æŒ‡å‘çš„ä½ç½®æ”¾ä¸Šä¸€æ®µä»£ç , å°±ä¼šè¿è¡Œ. >
å‚å•†ä¼šåœ¨ä¸»æ¿ä¸Šæ”¾ä¸€ä¸ªå°çš„å›ºä»¶èŠ¯ç‰‡,è¿™ä¸ªèŠ¯ç‰‡é‡Œé¢å­˜å‚¨æœ‰ä»£ç , æœ‰æ•°æ®.
æ¯”å¦‚é‡å¯ç”µè„‘æ—¶å€™çš„ logo, å°±æ˜¯å‚å•†å†™è¿›å»çš„ ROM(åªè¯»å­˜å‚¨å™¨,
å­˜å‚¨ç³»ç»Ÿå¼•å¯¼ç¨‹åº)é‡Œçš„ä¸€éƒ¨åˆ†. è¿™æ˜¯ä¸»æ¿å‚å•†å’Œ cpu å‚å•†ä¹‹é—´çš„çº¦å®š.

å‚å•†è¿˜ä¼šå’Œæ“ä½œç³»ç»Ÿå¼€å‘è€…å†æœ‰ä¸€å±‚çº¦å®š, å‚å•†ä¸ºæ“ä½œç³»ç»Ÿå¼€å‘è€…æä¾› Firmware

> Firmware åµŒå…¥å¼è®¾å¤‡ä¸­çš„ä¸€ç§è½¯ä»¶ç±»å‹, å®ƒæ˜¯ä¸€ç»„æŒ‡ä»¤å’Œæ•°æ®,
è¢«å­˜å‚¨åœ¨ç¡¬ä»¶è®¾å¤‡çš„éæ˜“å¤±æ€§å­˜å‚¨å™¨(å¦‚é—ªå­˜, EEPROM).ä¸æ“ä½œç³»ç»Ÿä¸åŒ,
å›ºä»¶é€šå¸¸è¢«æ°¸ä¹…åœ°ç¼–ç¨‹åˆ°ç¡¬ä»¶è®¾å¤‡ä¸­, ä»¥æ‰§è¡Œç‰¹å®šçš„åŠŸèƒ½æˆ–æ§åˆ¶è®¾å¤‡çš„æ“ä½œ.

- ç®¡ç†ç¡¬ä»¶å’Œç³»ç»Ÿé…ç½®
- æŠŠå­˜å‚¨è®¾å¤‡ä¸Šçš„ä»£ç åŠ è½½åˆ°å†…å­˜
  - ä¾‹å¦‚å­˜å‚¨ä»‹è´¨ä¸Šçš„ç¬¬äºŒçº§ loader (åŠ è½½å™¨)
  - æˆ–è€…ç›´æ¥åŠ è½½æ“ä½œç³»ç»Ÿ (åµŒå…¥å¼ç³»ç»Ÿ)

=== x86 Family: CPU Reset

CPU Reset ([ IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual
](https://software.intel.com/en-us/articles/intel-sdm), Volume 3A/3B)

- å¯„å­˜å™¨ä¼šæœ‰ç¡®å®šçš„åˆå§‹çŠ¶æ€
  - EIP = 0x0000fff0
  - CR0 = 0x60000010
    - å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼
  - EFLAGS = 0x00000002
    - Interrupt disabled
- TFM (5,000 é¡µ+)
  - æœ€éœ€è¦çš„ Volume 3A åªæœ‰ ~400 é¡µ (æˆ‘ä»¬æ›´éœ€è¦ AI)

=== å…¶ä»–å¹³å°ä¸Šçš„ CPU Reset

Reset åå¤„ç†å™¨éƒ½ä»å›ºå®šåœ°å€ (Reset Vector) å¯åŠ¨

- MIPS: 0xbfc00000
  - Specification è§„å®š
- ARM: 0x00000000
  - Specification è§„å®š
  - å…è®¸é…ç½® Reset Vector Base Address Register(è¿™æ ·è½¯ä»¶å¯ä»¥è‡ªç”±è®¾ç½®, å¯ä»¥ä¸ä»
    0x00000000 æ¥å¯åŠ¨.)
- RISC-V: Implementation defined
  - ç»™å‚å•†æœ€å¤§ç¨‹åº¦çš„è‡ªç”±

Firmware è´Ÿè´£åŠ è½½æ“ä½œç³»ç»Ÿ

- å¼€å‘æ¿ï¼šç›´æ¥æŠŠåŠ è½½å™¨å†™å…¥ ROM
- QEMUï¼š-kernel å¯ä»¥ç»•è¿‡ Firmware ç›´æ¥åŠ è½½å†…æ ¸ (RTFM)

=== x86 CPU Reset ä¹‹åï¼šåˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆï¼Ÿ

çŠ¶æ€æœº (åˆå§‹çŠ¶æ€) å¼€å§‹æ‰§è¡Œ

- ä» PC å–æŒ‡ä»¤, è¯‘ç , æ‰§è¡Œ...
- å¼€å§‹æ‰§è¡Œå‚å•† "å®‰æ’å¥½" çš„ Firmware ä»£ç 
  - x86 Reset Vector æ˜¯ä¸€æ¡å‘ Firmware è·³è½¬çš„ jmp æŒ‡ä»¤

Firmware: [ BIOS vs. UEFI ](https://www.zhihu.com/question/21672895)

- ä¸€ä¸ªå° "æ“ä½œç³»ç»Ÿ"
  - ç®¡ç†, é…ç½®ç¡¬ä»¶ï¼›åŠ è½½æ“ä½œç³»ç»Ÿ
- Legacy BIOS (Basic I/O System)
  - IBM PC æ‰€æœ‰è®¾å¤‡/BIOS ä¸­æ–­æ˜¯æœ‰ specification çš„ (æˆå°±äº† "å…¼å®¹æœº")
- UEFI (Unified Extensible Firmware Interface)

==== ä¸ºä»€ä¹ˆéœ€è¦ UEFIï¼Ÿ

ä»Šå¤©çš„ Firmware é¢ä¸´éº»çƒ¦å¾—å¤šçš„ç¡¬ä»¶ï¼š æŒ‡çº¹é”, USB è½¬æ¥å™¨ä¸Šçš„ Linux-to-Go ä¼˜ç›˜,
å±±å¯¨ç½‘å¡ä¸Šçš„ PXE ç½‘ç»œå¯åŠ¨, USB è“ç‰™è½¬æ¥å™¨è¿æ¥çš„è“ç‰™é”®ç›˜, ...

è¿™äº›è®¾å¤‡éƒ½éœ€è¦ "é©±åŠ¨ç¨‹åº" æ‰èƒ½è®¿é—® è§£å†³ BIOS é€æ¸ç¢ç‰‡åŒ–çš„é—®é¢˜

==== å›åˆ° Legacy BIOS: çº¦å®š

BIOS æä¾›ä¸€ä¸ªæœºåˆ¶:å°†ç¨‹åºå‘˜çš„ä»£ç è½½å…¥å†…å­˜

- Legacy BIOS (é€ä¸ªæ‰«æ, A ç›˜,B ç›˜..)æŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡çš„ç¬¬ä¸€ä¸ª 512
  å­—èŠ‚(MBR,Master Boot Record, 0 å·æ‰‡åŒº)åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ 7c00 ä½ç½®
  - æ­¤æ—¶å¤„ç†å™¨å¤„äº 16-bit æ¨¡å¼
  - è§„å®š CS:IP = 0x7c00, (R[CS] << 4) | R[IP] == 0x7c00
    - å¯èƒ½æ€§ 1ï¼šCS = 0x07c0, IP = 0
    - å¯èƒ½æ€§ 2ï¼šCS = 0, IP = 0x7c00
  - å…¶ä»–æ²¡æœ‰ä»»ä½•çº¦æŸ

è™½ç„¶æœ€å¤šåªæœ‰ 446 å­—èŠ‚ä»£ç  (64B åˆ†åŒºè¡¨ + 2B æ ‡è¯†) ä½†æ§åˆ¶æƒå·²ç»å›åˆ°ç¨‹åºå‘˜æ‰‹ä¸­äº†ï¼
ä½ ç”šè‡³å¯ä»¥è®© ChatGPT ç»™ä½ å†™ä¸€ä¸ª Hello World, å½“ç„¶, ä»–æ˜¯æŠ„ä½œä¸šçš„
(è€Œä¸”æ˜¯æœ‰äº›å°é—®é¢˜çš„)

===== ä¸¾ä¾‹

cpu reset(intel) CS:IP(0xffffh:0x0000h) å½¢æˆ physical address 0xffff0->Firmware
æŠŠ MBR åŠ è½½åˆ°å†…å­˜çš„ 0x7c00

```
                        0x7c00
                        |
                        v
      -----------------------------------------------
      |                 |                  |
      |                 |    MBR           |
      |                 |                  |
      -----------------------------------------------
                        ^
                        |
                       pc
```

ä¸ºäº†æ ‡è®°ä¸€ä¸ªåˆ†åŒºå¯ä¸å¯ä»¥å¯åŠ¨, ä¼šåœ¨ 512 å­—èŠ‚çš„æœ€åå†™ä¸Šä¸¤ä¸ªå­—èŠ‚çš„ magic number:
0x55,0xAA,è¡¨ç¤ºå¯ä»¥å¯åŠ¨.

> è¿½é—®, åˆ°åº•å“ªäº›æŒ‡ä»¤æŠŠè¿™ä¸ª 512 å­—èŠ‚æ¬åˆ°äº†å†…å­˜.

=== èƒ½ä¸èƒ½çœ‹ä¸€ä¸‹ä»£ç ï¼Ÿ

_Talk is cheap. Show me the code. â€”â€”Linus Torvalds_

æœ‰æ²¡æœ‰å¯èƒ½æˆ‘ä»¬çœŸçš„å»çœ‹ä» CPU Reset ä»¥åæ¯ä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œï¼Ÿ

è®¡ç®—æœºç³»ç»Ÿå…¬ç†ï¼šä½ æƒ³åˆ°çš„å°±ä¸€å®šæœ‰äººåšåˆ°

æ¨¡æ‹Ÿæ–¹æ¡ˆï¼šQEMU ä¼ å¥‡é»‘å®¢, å¤©æ‰ç¨‹åºå‘˜ Fabrice Bellard çš„æ°ä½œ QEMU, A fast and
portable dynamic translator (USENIX ATC'05) Android Virtual Device, VirtualBox,
... èƒŒåéƒ½æ˜¯ QEMU çœŸæœºæ–¹æ¡ˆï¼šJTAG (Joint Test Action Group) debugger ä¸€ç³»åˆ—
(ç‰©ç†) è°ƒè¯•å¯„å­˜å™¨, å¯ä»¥å®ç° gdb æ¥å£ (!!!)

=== ï¸ğŸŒ¶ï¸ UEFI ä¸Šçš„æ“ä½œç³»ç»ŸåŠ è½½

æ ‡å‡†åŒ–çš„åŠ è½½æµç¨‹

- ç£ç›˜å¿…é¡»æŒ‰ GPT (GUID Partition Table) æ–¹å¼æ ¼å¼åŒ–
- é¢„ç•™ä¸€ä¸ª FAT32 åˆ†åŒº (lsblk/fdisk å¯ä»¥çœ‹åˆ°)
- Firmware èƒ½å¤ŸåŠ è½½ä»»æ„å¤§å°çš„ PE å¯æ‰§è¡Œæ–‡ä»¶ .efi(æŒ‚åœ¨ç›¸åº”çš„ FAT32
  åˆ†åŒºä¹‹åå¯ä»¥çœ‹åˆ°ç›¸åº”çš„.efi æ–‡ä»¶)
  - æ²¡æœ‰ legacy boot 512 å­—èŠ‚é™åˆ¶
  - EFI åº”ç”¨å¯ä»¥è¿”å› firmware

æ›´å¥½çš„ç¨‹åºæ”¯æŒ

- è®¾å¤‡é©±åŠ¨æ¡†æ¶
- æ›´å¤šçš„åŠŸèƒ½, ä¾‹å¦‚ Secure Boot, åªèƒ½å¯åŠ¨ "ä¿¡ä»»" çš„æ“ä½œç³»ç»Ÿ

> å’Œ legacy bios åŸºæœ¬ä¸Šä¸€æ ·çš„. åªæ˜¯å¤šäº†ä¸€äº›é¢å¤–çš„çº¦å®š.

=== å°æ’æ›²ï¼šHacking Firmware (1998)

Firmware é€šå¸¸æ˜¯åªè¯»çš„ (å½“ç„¶)...

Intel 430TX (Pentium) èŠ¯ç‰‡ç»„å…è®¸å†™å…¥ Flash ROM åªè¦å‘ Flash BIOS å†™å…¥ç‰¹å®šåºåˆ—,
Flash ROM å°±å˜ä¸ºå¯å†™ ç•™ç»™ Firmware æ›´æ–°çš„é€šé“ è¦å¾—åˆ°è¿™ä¸ªåºåˆ—å…¶å®å¹¶ä¸å›°éš¾
ä¼¼ä¹æ–‡æ¡£é‡Œå°±æœ‰ ğŸ¤” Boom... CIH ç—…æ¯’çš„ä½œè€…é™ˆç›ˆè±ªè¢«é€®æ•, ä½†å¹¶æœªè¢«å®šç½ª

== å®ç°æœ€å° "æ“ä½œç³»ç»Ÿ"

=== æˆ‘ä»¬å·²ç»è·å¾—çš„èƒ½åŠ›

ä¸ºç¡¬ä»¶ç›´æ¥ç¼–ç¨‹

- å¯ä»¥è®©æœºå™¨è¿è¡Œä»»æ„ä¸è¶…è¿‡ 510 å­—èŠ‚çš„æŒ‡ä»¤åºåˆ—
- ç¼–å†™ä»»ä½•æŒ‡ä»¤åºåˆ— (çŠ¶æ€æœº)
  - åªè¦èƒ½é—®å‡ºé—®é¢˜, å°±å¯ä»¥ RTFM/STFW/ChatGPT æ‰¾åˆ°ç­”æ¡ˆ
    - "å¦‚ä½•åœ¨æ±‡ç¼–é‡Œç”Ÿæˆ n ä¸ªå­—èŠ‚çš„ 0"
    - "å¦‚ä½•åœ¨ x86 16-bit mode æ‰“å°å­—ç¬¦"

æ“ä½œç³»ç»Ÿï¼šå°±ä¸€ä¸ª C ç¨‹åº

- ç”¨ 510 å­—èŠ‚çš„æŒ‡ä»¤å®Œæˆç£ç›˜ â†’ å†…å­˜çš„åŠ è½½
- åˆå§‹åŒ– C ç¨‹åºçš„æ‰§è¡Œç¯å¢ƒ
- æ“ä½œç³»ç»Ÿå°±å¼€å§‹è¿è¡Œäº†ï¼

=== å®ç°æ“ä½œç³»ç»Ÿï¼šè§‰å¾— "å¿ƒé‡Œæ²¡åº•"ï¼Ÿ

å¿ƒè·¯å†ç¨‹

- æ›¾ç»çš„æˆ‘ï¼šå“‡ï¼è¿™ä¹Ÿå¯ä»¥ï¼Ÿ
- ç°åœ¨çš„æˆ‘ï¼šå“¦.å‘µå‘µå‘µ.

å¤§å­¦çš„çœŸæ­£æ„ä¹‰

- è¿…é€Ÿæ¶ˆåŒ–æ•°åå¹´æ¥å»ºç«‹èµ·çš„å­¦ç§‘ä½“ç³»
  - å°†å·²æœ‰çš„æ€æƒ³å’Œæ–¹æ³•é‡æ–°ç»„ç»‡, ä¸ºå¤§å®¶å»ºç«‹å¥½ "å°é˜¶"
- ç ´é™¤ "å†™æ“ä½œç³»ç»Ÿå¾ˆéš¾", "å†™æ“ä½œç³»ç»Ÿå¾ˆç‰›" ç±»ä¼¼çš„é”™è¯¯è®¤è¯†
  - æ“ä½œç³»ç»ŸçœŸçš„å°±æ˜¯ä¸ª C ç¨‹åº
  - ä½ åªæ˜¯éœ€è¦ "è¢«æ­£ç¡®å‘ŠçŸ¥" ä¸€äº›é¢å¤–çš„çŸ¥è¯†
    - ç„¶åå†™ä»£ç , åƒè‹¦å¤´
    - ä»è€Œå»ºç«‹æ­£ç¡®çš„ "ä¸“ä¸šä¸–ç•Œè§‚"

=== Bare-metal ä¸Šçš„ C ä»£ç 

ä¸ºäº†è®©ä¸‹åˆ—ç¨‹åºèƒ½å¤Ÿ "è¿è¡Œèµ·æ¥"ï¼š

```c
int main() {
  printf("Hello, World\n");
}
```

æˆ‘ä»¬éœ€è¦å‡†å¤‡ä»€ä¹ˆï¼Ÿ

- MBR ä¸Šçš„ "å¯åŠ¨åŠ è½½å™¨" (Boot Loader)
- æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨æ§åˆ¶ C ç¨‹åºçš„è¡Œä¸º
  - é™æ€é“¾æ¥/PIC (ä½ç½®æ— å…³ä»£ç )
  - Freestanding (ä¸ä½¿ç”¨ä»»ä½•æ ‡å‡†åº“)
  - è‡ªå·±æ‰‹å·¥å®ç°åº“å‡½æ•° (putch, printf, ...)
    - æœ‰äº¿ç‚¹ç‚¹ç»†èŠ‚ï¼šRTFSC!

=== è¿›å…¥ç»†èŠ‚çš„æµ·æ´‹

å¥½æ¶ˆæ¯ï¼šæˆ‘ä»¬æä¾›äº†è¿è¡Œ C ç¨‹åºçš„æ¡†æ¶ä»£ç å’Œåº“ åæ¶ˆæ¯ï¼šæ¡†æ¶ä»£ç ä¹Ÿå¤ªå¤æ‚äº†å§

- è¢« ICS PA æ”¯é…çš„ææƒ§å†æ¬¡è¢­æ¥...
  - è¯»æ‡‚ Makefile éœ€è¦ STFW, RTFM, å¤§é‡çš„ç²¾åŠ›
  - è¯»äº†å¾ˆä¹…éƒ½æ²¡è¯»åˆ°é‡è¦çš„åœ°æ–¹ â†’ æœ¬èƒ½åœ°æ”¾å¼ƒ

ä¾‹å¦‚é˜…è¯» am çš„ makefile èŠ±ä¸€ç‚¹æ—¶é—´æƒ³ "æœ‰æ›´å¥½çš„åŠæ³•å—ï¼Ÿ"

- èŠ±å‡ åˆ†é’Ÿåˆ›å»ºä¸€ä¸ªå°å·¥å…·ï¼š"æ„å»ºç†è§£å·¥å…·"
  - UNIX Philosophy
  - æŠŠå¤æ‚çš„æ„å»ºè¿‡ç¨‹åˆ†è§£æˆæµç¨‹ + å¯ç†è§£çš„å•ç‚¹
- Get out of your comfort zone

==== (1) ç”Ÿæˆé•œåƒå’Œå¯åŠ¨è™šæ‹Ÿæœº

è§‚å¯Ÿ AbstractMachine ç¨‹åºç¼–è¯‘è¿‡ç¨‹çš„æ­£ç¡®æ–¹æ³•ï¼š

```sh
make -nB \
  | grep -ve '^\(\#\|echo\|mkdir\|make\)' \
  | sed "s#$AM_HOME#\$AM_HOME#g" \
  | sed "s#$PWD#.#g" \
  | vim -
```

Command line tricks

- `make -nB` (RTFM)
- `grep`: æ–‡æœ¬è¿‡æ»¤, çœç•¥äº†ä¸€äº›å¹²æ‰°é¡¹
  - `echo` (æç¤ºä¿¡æ¯), `mkdir` (ç›®å½•å»ºç«‹), `make` (sub-goals)
- `sed`: è®©è¾“å‡ºæ›´æ˜“è¯»
  - å°†ç»å¯¹è·¯å¾„æ›¿æ¢æˆç›¸å¯¹è·¯å¾„
- `vim`: æ›´èˆ’é€‚çš„ç¼–è¾‘/æŸ¥çœ‹ä½“éªŒ

==== (2) æ”¹è¿›æ–‡æœ¬å¯è¯»æ€§

æƒ³è¦çœ‹å¾—æ›´æ¸…æ¥šä¸€äº›ï¼Ÿ

`:%s/ /\r /g`

- æ¯ä¸€ä¸ªå‘½ä»¤å°±åƒ "ä¸€å¥è¯"
- AI è½å, ä¸€ä»£äººå°±è½å
  - æˆ‘çš„å­¦ä¹ å†ç¨‹ (~2010)ï¼šçœ‹ä¹¦, åœ¨åºŠä¸Šåˆ· Wikipedia

ç¼–è¯‘/é“¾æ¥

- `-std=gnu11`, `-m64`, `-mno-sse`, `-I`, `-D`, ...
  - å®ƒä»¬æ˜¯å¯¼è‡´ vscode é‡Œçº¢çº¿çš„åŸå› 
- `-melf_x86_64`, `-N`, `-Ttext-segment=0x00100000`
  - é“¾æ¥äº†éœ€è¦çš„åº“ (am-x86_64-qemu.a, klib-x86_64-qemu.a)

==== (3) å¯åŠ¨åŠ è½½å™¨ (Boot Loader)

å‡è®¾ MBR åç´§è·Ÿ ELF Binary (çœŸæ­£çš„çš„åŠ è½½å™¨æœ‰æ›´å¤š stages)

- 16-bit â†’ 32-bit
- ELF32/64 çš„åŠ è½½å™¨
- æŒ‰ç…§çº¦å®šçš„ç£ç›˜é•œåƒæ ¼å¼åŠ è½½

ä»£ç è®²è§£ï¼š am/src/x86/qemu/boot/start.S å’Œ main.c æœ€ç»ˆå®Œæˆäº† C ç¨‹åºçš„åŠ è½½
(å®ƒä»¬éƒ½å¯ä»¥è°ƒè¯•)

```c
if (elf32->e_machine == EM_X86_64) {
  ((void(*)())(uint32_t)elf64->e_entry)();
} else {
  ((void(*)())(uint32_t)elf32->e_entry)();
}
```

=== æˆ‘ä»¬æ‰¿è¯ºçš„ "æ“ä½œç³»ç»Ÿ"

å°±æ˜¯ä¸€ä¸ª C ç¨‹åº

- åªä¸è¿‡è°ƒç”¨äº†æ›´å¤šçš„ API (ä¹‹åè§£é‡Š)
  - ä½¿ç”¨äº†æ­£ç¡®çš„å·¥å…·, å°±æ²¡ä»€ä¹ˆå›°éš¾çš„

æ”¯æŒå›ºå®šçš„ "çº¿ç¨‹"

- Ta â€‹- while (1) printf("a");
- Tb â€‹- while (1) printf("b");
  - å…è®¸å¹¶å‘æ‰§è¡Œ

== ç¼–ç¨‹å®è·µ

=== mbr

mbr.S

```asm
#define SECT_SIZE  512

.code16  // 16-bit assembly

// Entry of the code
.globl _start
_start:
  lea   (msg), %si   // R[si] = &msg;

again:
  movb  (%si), %al   // R[al] = *R[si]; <--+
  incw  %si          // R[si]++;           |
  orb   %al, %al     // if (!R[al])        |
  jz    done         //   goto done; --+   |
  movb  $0x0e, %ah   // R[ah] = 0x0e;  |   |
  movb  $0x00, %bh   // R[bh] = 0x00;  |   |
  int   $0x10        // bios_call();   |   |
  jmp   again        // goto again; ---+---+
                     //                |
done:                //                |
  jmp   .            // goto done; <---+

// Data: const char msg[] = "...";
msg:
  .asciz "This is a baby step towards operating systems!\r\n"

// Magic number for bootable device
.org SECT_SIZE - 2
.byte 0x55, 0xAA
```

`int   $0x10        // bios_call();`è¿™é‡Œå¯ä»¥è·³è½¬åˆ° firmware æ‰§è¡Œ. qemu çš„
firmware åœ¨å†…å­˜çš„ä»€ä¹ˆä½ç½®?

```makefile
mbr.img: mbr.S
  gcc -ggdb -c $<
  ld mbr.o -Ttext 0x7c00
  objcopy -S -O binary -j .text a.out $@
```

é¦–å…ˆç¼–è¯‘å‡º mbr.o, æ¥ç€é“¾æ¥åˆ° 0x7c00 å¤„.
`objcopy -S -O binary -j .text a.out $@`ï¼šè¿™è¡ŒæŒ‡ä»¤ä½¿ç”¨ objcopy å·¥å…·å°† a.out
å¯æ‰§è¡Œæ–‡ä»¶ä¸­çš„åªè¯» `.text` æ®µå¤åˆ¶åˆ°ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ mbr.img ä¸­.`-S` é€‰é¡¹è¡¨ç¤ºå»é™¤æ‰€æœ‰ç¬¦å·ä¿¡æ¯, `-O binary` é€‰é¡¹è¡¨ç¤ºè¾“å‡ºäºŒè¿›åˆ¶æ ¼å¼æ–‡ä»¶, `-j .text` é€‰é¡¹è¡¨ç¤ºåªå¤åˆ¶ `.text` æ®µ.

çœ‹ä¸€ä¸‹è¿™ 512 ä¸ªå­—èŠ‚:

```
â¯ xxd mbr.img
00000000: 8d36 157c 8a04 4608 c074 08b4 0eb7 00cd  .6.|..F..t......
00000010: 10eb f1eb fe54 6869 7320 6973 2061 2062  .....This is a b
00000020: 6162 7920 7374 6570 2074 6f77 6172 6473  aby step towards
00000030: 206f 7065 7261 7469 6e67 2073 7973 7465   operating syste
00000040: 6d73 210d 0a00 0000 0000 0000 0000 0000  ms!.............
00000050: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000060: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000070: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000080: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000090: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000f0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000100: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000110: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000120: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000130: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000140: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000150: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000160: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000170: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000180: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000190: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001a0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001c0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001d0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001e0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000001f0: 0000 0000 0000 0000 0000 0000 0000 55aa  ..............U.
```

=== qemu è°ƒè¯•

gdb è°ƒè¯•çš„æ—¶å€™æ˜¯ 16 ä½æ¨¡å¼, ä»£ç æ˜¯ 64 ä½çš„, æ‰€ä»¥ä¼šæœ‰äº›å°é—®é¢˜æ¯”å¦‚åœ¨`x/10i $cs * 16 + $rip`çš„æ—¶å€™.

```sh
â¯ qemu-system-x86_64 -s -S mbr.img &
[1] 26553
....
â¯ gdb
GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
....
0x000000000000fff0 in ?? ()
(gdb) p $rip
$1 = (void (*)()) 0xfff0
(gdb) p/x $cs
$3 = 0xf000
(gdb) p/x $cs * 16 + $rip
$4 = 0xffff0
(gdb) x/10i $cs * 16 + $rip
   0xffff0:     (bad)
   0xffff1:     pop    %rbx
   0xffff2:     loopne 0xffff4
   0xffff4:     lock xor %dh,(%rsi)
   0xffff7:     (bad)
   0xffff8:     xor    (%rbx),%dh
   0xffffa:     (bad)
   0xffffb:     cmp    %edi,(%rcx)
   0xffffd:     add    %bh,%ah
   0xfffff:     add    %al,(%rax)
(gdb) x/10x $cs * 16 + $rip
0xffff0:        0x00e05bea      0x2f3630f0      0x392f3332      0x00fc0039
0x100000:       0x00000000      0x00000000      0x00000000      0x00000000
0x100010:       0x00000000      0x00000000
(gdb) si
0x000000000000e05b in ?? ()
(gdb) p/x $cs * 16 + $rip
$5 = 0xfe05b
(gdb) x/10i $cs * 16 + $rip
   0xfe05b:     cs cmpw $0xffc8,(%rsi)
   0xfe060:     (bad)
   0xfe061:     add    %cl,(%rdi)
   0xfe063:     test   %ecx,-0x10(%rax)
   0xfe066:     xor    %edx,%edx
   0xfe068:     mov    %edx,%ss
   0xfe06a:     mov    $0x7000,%sp
   0xfe06e:     add    %al,(%rax)
   0xfe070:     mov    $0xfc1c,%dx
   0xfe074:     (bad)
(gdb) b *0x7c00
Breakpoint 1 at 0x7c00
(gdb) c
Continuing.
Breakpoint 1, 0x0000000000007c00 in ?? ()
```

èµ·åˆ pc åœ¨`0xffff0`, æ¥ç€å•æ­¥æ‰§è¡Œä¸€æ­¥è·³è½¬åˆ°`0xfe05b`.æ¥ç€æ‰“æ–­ç‚¹åœ¨`0x7c00`,è¿è¡Œ.

å¯ä»¥çœ‹åˆ° #image("images/2023-09-22-17-24-28.png")
ä½†æ˜¯ hello è¿˜æ²¡æœ‰æ‰“å°å‡ºæ¥. ç„¶å`layout asm`çœ‹çœ‹å°±æ˜¯åˆšåˆšæ±‡ç¼–ä»£ç .

`man qemu-system`:
`-S`: Do not start CPU at startup (you must type 'c' in the monitor).
`-s`: Shorthand for `-gdb tcp::1234`, i.e. open a gdbserver on TCP port 1234
(see the GDB usage chapter in the System Emulation Users Guide).

> 0xffff0 è¿™ä¸ªåœ°å€å¤„çš„ä»£ç æ˜¯ä¸€ä¸ªè·³è½¬æŒ‡ä»¤, ç”¨äºå°†æ§åˆ¶æƒè½¬ç§»åˆ°å®é™…çš„ BIOS
ä»£ç æ‰€åœ¨çš„å†…å­˜åœ°å€.

==== æŠŠè°ƒè¯•æ­¥éª¤å­˜å‚¨æˆæ–‡ä»¶

è°ƒè¿‡å¤´äº†æ€ä¹ˆåŠ?å­˜å‚¨æˆæ–‡ä»¶`init.gdb`

```gdb
= Kill process (QEMU) on gdb exits
define hook-quit
  kill
end

= Connect to remote
target remote localhost:1234
file a.out
wa *0x7c00
break *0x7c00
layout src
continue
```

```makefile
debug: mbr.img
  qemu-system-x86_64 -s -S $< &  = Run QEMU in background
  gdb -x init.gdb  = RTFM: gdb (1)
```

`make debug` å¾ˆä¸æ»‘åœ°è¿›å…¥ `0x7c00` çš„è°ƒè¯•ç•Œé¢.ç„¶å`q`è¿˜èƒ½ä¸æ»‘åœ°é€€å‡º gdb.

==== æƒ³çŸ¥é“ 0x7c00 åˆ°åº•æ˜¯è°åŠ è½½çš„

`wa *0x7c00`, ç„¶å`make debug`å‘ç°ä¸€å¼€å§‹åªæœ‰ä¸¤ä¸ªå­—èŠ‚è¢«åŠ è½½äº†, å‰©ä¸‹çš„éƒ½æ˜¯ 0.
ç„¶åå•æ­¥æ‰§è¡Œå‡ æ­¥ä¹‹åæ‰å¼€å§‹é€æ¸åŠ è½½åˆ°å†…å­˜.

```sh
Hardware watchpoint 1: *0x7c00

Old value = 0
New value = 13965
0x000000000000a718 in ?? ()
(gdb) x/10x 0x7c00
0x7c00 <_start>:        0x0000368d      0x00000000      0x00000000      0x00000000
0x7c10 <again+12>:      0x00000000      0x00000000      0x00000000      0x00000000
0x7c20 <msg+11>:        0x00000000      0x00000000
(gdb) si

Hardware watchpoint 1: *0x7c00

Old value = 13965
New value = 2081765005
0x000000000000a718 in ?? ()
0x000000000000a718 in ?? ()
0x000000000000a718 in ?? ()
0x000000000000a718 in ?? ()
(gdb) x/10x 0x7c00
0x7c00 <_start>:        0x7c15368d      0x0846048a      0x00000000      0x00000000
0x7c10 <again+12>:      0x00000000      0x00000000      0x00000000      0x00000000
0x7c20 <msg+11>:        0x00000000      0x00000000
```

=== ç¼–è¯‘è¿è¡Œæ“ä½œç³»ç»Ÿå†…æ ¸

am çš„ makefile è®©æˆ‘ä»¬æˆåŠŸç”Ÿæˆäº†ç›´æ¥åœ¨ç¡¬ä»¶ä¸Šè¿è¡Œçš„ç¨‹åº.

> CMake èƒŒååšäº†å¾ˆå¤šä¸œè¥¿, ä¸æ¸…æ¥šç»†èŠ‚å¾ˆéš¾è°ƒè¯•. Makefile
å¯ä»¥æŠŠåº•å±‚æ‰€æœ‰çš„ç»†èŠ‚éƒ½å±•ç°å‡ºæ¥.

çœ‹æºç å¾ˆéš¾, çœ‹æ‰§è¡Œçš„è¿‡ç¨‹å°±ä¼šå®¹æ˜“ä¸€äº›.(çŠ¶æ€æœºçš„æè¿°å’ŒçŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»)

ç†è§£ Abstract machine çš„ makefile

```sh
make -nB \
  | grep -ve '^\(\#\|echo\|mkdir\|make\)' \
  | sed "s#$AM_HOME#\$AM_HOME#g" \
  | sed "s#$PWD#.#g" \
  | vim -
```

æ¥ç€`:%s/ /\r/g`
